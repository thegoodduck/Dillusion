import sys
import os
import base64
from PyQt5.QtWidgets import QApplication, QWizard, QWizardPage, QVBoxLayout, QLabel, QLineEdit, QCheckBox, QGroupBox, QRadioButton, QPushButton
from PyQt5.QtCore import Qt
import shutil
# Base64-encoded contents of main.py
MAIN_PY = b'IyEvdXNyL2Jpbi9weXRob24zCiMgSW1wb3J0aW5nIHJlcXVpcmVkIGxpYnJhcmllcwppbXBvcnQgc3lzCmltcG9ydCB0a2ludGVyIGFzIHRrCmltcG9ydF9zdWNlc3NmdWxsID0gVHJ1ZQp0cnk6CiAgICBmcm9tIFB5UXQ1LlF0Q29yZSBpbXBvcnQgKgpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBpbXBvcnQgc3VicHJvY2VzcwogICAgcm9vdCA9IHRrLlRrKCkKICAgIHJvb3QudGl0bGUoIkluc3RhbGxpbmcgRGVwZW5kZW5jaWVzIikKICAgIGxhYmVsID0gdGsuTGFiZWwocm9vdCwgdGV4dD0iSW5zdGFsbGluZyBEZXBlbmRlbmNpZXMuLi4iKQogICAgbGFiZWwucGFjaygpCiAgICByb290LnVwZGF0ZSgpCiAgICBzdWJwcm9jZXNzLmNoZWNrX2NhbGwoW3N5cy5leGVjdXRhYmxlLCAiLW0iLCAicGlwIiwgImluc3RhbGwiLCAiUHlRdDUiLCAiLS1icmVhay1zeXN0ZW0tcGFja2FnZXMiXSkKICAgIGltcG9ydF9zdWNlc3NmdWxsID0gRmFsc2UKdHJ5OgogICAgZnJvbSBQeVF0NS5RdFdpZGdldHMgaW1wb3J0ICoKZXhjZXB0IEltcG9ydEVycm9yOgogICAgaW1wb3J0IHN1YnByb2Nlc3MKICAgIHJvb3QgPSB0ay5UaygpCiAgICByb290LnRpdGxlKCJJbnN0YWxsaW5nIERlcGVuZGVuY2llcyIpCiAgICBsYWJlbCA9IHRrLkxhYmVsKHJvb3QsIHRleHQ9Ikluc3RhbGxpbmcgRGVwZW5kZW5jaWVzLi4uIikKICAgIGxhYmVsLnBhY2soKQogICAgcm9vdC51cGRhdGUoKQogICAgc3VicHJvY2Vzcy5jaGVja19jYWxsKFtzeXMuZXhlY3V0YWJsZSwgIi1tIiwgInBpcCIsICJpbnN0YWxsIiwgIlB5UXQ1IiwgIi0tYnJlYWstc3lzdGVtLXBhY2thZ2VzIl0pCiAgICBpbXBvcnRfc3VjZXNzZnVsbCA9IEZhbHNlCgp0cnk6CiAgICBmcm9tIFB5UXQ1LlF0R3VpIGltcG9ydCAqCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGltcG9ydCBzdWJwcm9jZXNzCiAgICByb290ID0gdGsuVGsoKQogICAgcm9vdC50aXRsZSgiSW5zdGFsbGluZyBEZXBlbmRlbmNpZXMiKQogICAgbGFiZWwgPSB0ay5MYWJlbChyb290LCB0ZXh0PSJJbnN0YWxsaW5nIERlcGVuZGVuY2llcy4uLiIpCiAgICBsYWJlbC5wYWNrKCkKICAgIHJvb3QudXBkYXRlKCkKICAgIHN1YnByb2Nlc3MuY2hlY2tfY2FsbChbc3lzLmV4ZWN1dGFibGUsICItbSIsICJwaXAiLCAiaW5zdGFsbCIsICJQeVF0NSIsICItLWJyZWFrLXN5c3RlbS1wYWNrYWdlcyJdKQogICAgaW1wb3J0X3N1Y2Vzc2Z1bGwgPSBGYWxzZQoKdHJ5OgogICAgZnJvbSBQeVF0NS5RdFdlYkVuZ2luZVdpZGdldHMgaW1wb3J0ICoKZXhjZXB0IEltcG9ydEVycm9yOgogICAgaW1wb3J0IHN1YnByb2Nlc3MKICAgIHJvb3QgPSB0ay5UaygpCiAgICByb290LnRpdGxlKCJJbnN0YWxsaW5nIERlcGVuZGVuY2llcyIpCiAgICBsYWJlbCA9IHRrLkxhYmVsKHJvb3QsIHRleHQ9Ikluc3RhbGxpbmcgRGVwZW5kZW5jaWVzLi4uIikKICAgIGxhYmVsLnBhY2soKQogICAgcm9vdC51cGRhdGUoKQogICAgc3VicHJvY2Vzcy5jaGVja19jYWxsKFtzeXMuZXhlY3V0YWJsZSwgIi1tIiwgInBpcCIsICJpbnN0YWxsIiwgIlB5UXQ1IiwgIi0tYnJlYWstc3lzdGVtLXBhY2thZ2VzIl0pCiAgICBpbXBvcnRfc3VjZXNzZnVsbCA9IEZhbHNlCnRyeToKICAgIGZyb20gUHlRdDUuUXRXZWJFbmdpbmVDb3JlIGltcG9ydCBRV2ViRW5naW5lVXJsUmVxdWVzdEludGVyY2VwdG9yCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGltcG9ydCBzdWJwcm9jZXNzCiAgICByb290ID0gdGsuVGsoKQogICAgcm9vdC50aXRsZSgiSW5zdGFsbGluZyBEZXBlbmRlbmNpZXMiKQogICAgbGFiZWwgPSB0ay5MYWJlbChyb290LCB0ZXh0PSJJbnN0YWxsaW5nIERlcGVuZGVuY2llcy4uLiIpCiAgICBsYWJlbC5wYWNrKCkKICAgIHJvb3QudXBkYXRlKCkKICAgIHN1YnByb2Nlc3MuY2hlY2tfY2FsbChbc3lzLmV4ZWN1dGFibGUsICItbSIsICJwaXAiLCAiaW5zdGFsbCIsICJQeVF0NSIsICItLWJyZWFrLXN5c3RlbS1wYWNrYWdlcyJdKQogICAgaW1wb3J0X3N1Y2Vzc2Z1bGwgPSBGYWxzZQoKCnRyeToKICAgIGZyb20gUHlRdDUuUXROZXR3b3JrIGltcG9ydCBRTmV0d29ya1Byb3h5CmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGltcG9ydCBzdWJwcm9jZXNzCiAgICByb290ID0gdGsuVGsoKQogICAgcm9vdC50aXRsZSgiSW5zdGFsbGluZyBEZXBlbmRlbmNpZXMiKQogICAgbGFiZWwgPSB0ay5MYWJlbChyb290LCB0ZXh0PSJJbnN0YWxsaW5nIERlcGVuZGVuY2llcy4uLiIpCiAgICBsYWJlbC5wYWNrKCkKICAgIHJvb3QudXBkYXRlKCkKICAgIHN1YnByb2Nlc3MuY2hlY2tfY2FsbChbc3lzLmV4ZWN1dGFibGUsICItbSIsICJwaXAiLCAiaW5zdGFsbCIsICJQeVF0NSIsICItLWJyZWFrLXN5c3RlbS1wYWNrYWdlcyJdKQogICAgaW1wb3J0X3N1Y2Vzc2Z1bGwgPSBGYWxzZQoKaW1wb3J0IHN5cwppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IHNvY2tldAppbXBvcnQganNvbgppbXBvcnQgdGltZQppZiBpbXBvcnRfc3VjZXNzZnVsbCAhPSBUcnVlOgogICAgcHJpbnQoIltJTkZPXSBEZXBlbmRlbmNpZXMgc3VjY2Vzc2Z1bGx5IGluc3RhbGxlZCIpCiAgICAjIFJlaW1wb3J0IGFsbCBkZXBlbmRlbmNpZXMKICAgIGZyb20gUHlRdDUuUXRDb3JlIGltcG9ydCAqCiAgICBmcm9tIFB5UXQ1LlF0V2lkZ2V0cyBpbXBvcnQgKgogICAgZnJvbSBQeVF0NS5RdEd1aSBpbXBvcnQgKgogICAgZnJvbSBQeVF0NS5RdFdlYkVuZ2luZVdpZGdldHMgaW1wb3J0ICoKICAgIGZyb20gUHlRdDUuUXRXZWJFbmdpbmVDb3JlIGltcG9ydCBRV2ViRW5naW5lVXJsUmVxdWVzdEludGVyY2VwdG9yCiAgICBmcm9tIFB5UXQ1LlF0TmV0d29yayBpbXBvcnQgUU5ldHdvcmtQcm94eQogICAgcHJpbnQoIltJTkZPXSBSZWltcG9ydGluZyBkZXBlbmRlbmNpZXMiKQoKCiMgTG9hZCBhZCBzZWxlY3RvcnMgZnJvbSBmaWxlCnRyeToKICAgIHdpdGggb3BlbigiYWRfc2VsZWN0b3JzLmpzb24iLCAiciIpIGFzIGZpbGU6CiAgICAgICAgYWRfc2VsZWN0b3JzID0ganNvbi5sb2FkKGZpbGUpCmV4Y2VwdDoKICAgIHByaW50KCJbV0FSTl0gQ291bGQgbm90IGxvYWQgYWQgc2VsZWN0b3JzIikKICAgIGFkX3NlbGVjdG9ycyA9IFtdCmNsYXNzIExvYWRpbmdQcm9ncmVzc0JhcihRUHJvZ3Jlc3NCYXIpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoTG9hZGluZ1Byb2dyZXNzQmFyLCBzZWxmKS5fX2luaXRfXygqYXJncywgKiprd2FyZ3MpCiAgICAgICAgc2VsZi5zZXRTdHlsZVNoZWV0KCIiIgogICAgICAgICAgICBRUHJvZ3Jlc3NCYXIgewogICAgICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgZ3JleTsKICAgICAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgICAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBRUHJvZ3Jlc3NCYXI6OmNodW5rIHsKICAgICAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6ICMxRTkwRkY7IC8qIEJsdWUgY29sb3IgKi8KICAgICAgICAgICAgICAgIHdpZHRoOiAxMHB4OwogICAgICAgICAgICB9CiAgICAgICAgIiIiKQogICAgICAgIHNlbGYuc2V0TWF4aW11bSgxMDApCiAgICAgICAgc2VsZi5zZXRWYWx1ZSgwKQogICAgICAgIHNlbGYuc2V0Rm9ybWF0KCIldiUiKSAgIyBEaXNwbGF5IHRoZSBwcm9ncmVzcyB2YWx1ZQogICAgICAgIHNlbGYuc2V0QWxpZ25tZW50KFF0LkFsaWduQ2VudGVyKQogICAgZGVmIHNldF9kb3dubG9hZF9zcGVlZChzZWxmLCBzcGVlZCk6CiAgICAgICAgc2VsZi5zZXRGb3JtYXQoZiJ7c2VsZi52YWx1ZSgpfSUgLSB7c3BlZWR9IE1icHMiKQoKY2xhc3MgQWRibG9ja2VyKFFXZWJFbmdpbmVVcmxSZXF1ZXN0SW50ZXJjZXB0b3IpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygqYXJncywgKiprd2FyZ3MpCiAgICAgICAgc2VsZi5sb2FkX2Jsb2NrZWRfZG9tYWlucygpCgogICAgIyBMb2FkIGJsb2NrZWQgZG9tYWlucyBmcm9tIGZpbGUKICAgIGRlZiBsb2FkX2Jsb2NrZWRfZG9tYWlucyhzZWxmKToKICAgICAgICB3aXRoIG9wZW4oImJsb2NrZWRfZG9tYWlucy5qc29uIiwgInIiKSBhcyBmaWxlOgogICAgICAgICAgICBzZWxmLmJsb2NrZWRfZG9tYWlucyA9IGpzb24ubG9hZChmaWxlKQoKICAgICMgSW50ZXJjZXB0IHJlcXVlc3QgYW5kIGJsb2NrIGFkcwogICAgZGVmIGludGVyY2VwdFJlcXVlc3Qoc2VsZiwgaW5mbyk6CiAgICAgICAgdXJsID0gaW5mby5yZXF1ZXN0VXJsKCkudG9TdHJpbmcoKQogICAgICAgIGZvciBkb21haW4gaW4gc2VsZi5ibG9ja2VkX2RvbWFpbnM6CiAgICAgICAgICAgIGlmIGRvbWFpbiBpbiB1cmw6CiAgICAgICAgICAgICAgICBpbmZvLmJsb2NrKFRydWUpCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gQmxvY2tlZCBhZCByZXF1ZXN0OiB7dXJsfSIpCiAgICAgICAgICAgICAgICBicmVhawoKIyBNZXRob2QgdG8gaGlkZSBhZCBlbGVtZW50cwpkZWYgaGlkZV9hZF9lbGVtZW50cyhzZWxmKToKICAgIGpzX2Z1bmN0aW9uID0gIiIiCiAgICAgICAgZnVuY3Rpb24gaGlkZUFkRWxlbWVudHMoc2VsZWN0b3JzKSB7CiAgICAgICAgICAgIHNlbGVjdG9ycy5mb3JFYWNoKGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTsKICAgICAgICAgICAgICAgIGVsZW1lbnRzLmZvckVhY2goZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaGlkZUFkRWxlbWVudHMoJXMpOwogICAgIiIiICUganNvbi5kdW1wcyhhZF9zZWxlY3RvcnMpCiAgICBzZWxmLnRhYnMuY3VycmVudFdpZGdldCgpLnBhZ2UoKS5ydW5KYXZhU2NyaXB0KGpzX2Z1bmN0aW9uLCBsYW1iZGEgXzogTm9uZSkKICAgIHByaW50KCJbREVCVUddIEFkIGVsZW1lbnRzIGhpZGRlbiIpCgoKIyBMb2FkIGFkIHNlbGVjdG9ycyBmcm9tIGZpbGUKCmNsYXNzIEFkYmxvY2tlcihRV2ViRW5naW5lVXJsUmVxdWVzdEludGVyY2VwdG9yKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKmFyZ3MsICoqa3dhcmdzKQogICAgICAgIHNlbGYubG9hZF9ibG9ja2VkX2RvbWFpbnMoKQoKICAgICMgTG9hZCBibG9ja2VkIGRvbWFpbnMgZnJvbSBmaWxlCiAgICBkZWYgbG9hZF9ibG9ja2VkX2RvbWFpbnMoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oImJsb2NrZWRfZG9tYWlucy5qc29uIiwgInIiKSBhcyBmaWxlOgogICAgICAgICAgICAgICAgc2VsZi5ibG9ja2VkX2RvbWFpbnMgPSBqc29uLmxvYWQoZmlsZSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHByaW50KCJbV0FSTl0gQ291bGQgbm90IGxvYWQgYmxvY2tlZCBkb21haW5zIikKICAgICAgICAgICAgc2VsZi5ibG9ja2VkX2RvbWFpbnMgPSBbXQogICAgIyBJbnRlcmNlcHQgcmVxdWVzdCBhbmQgYmxvY2sgYWRzCiAgICBkZWYgaW50ZXJjZXB0UmVxdWVzdChzZWxmLCBpbmZvKToKICAgICAgICB1cmwgPSBpbmZvLnJlcXVlc3RVcmwoKS50b1N0cmluZygpCiAgICAgICAgZm9yIGRvbWFpbiBpbiBzZWxmLmJsb2NrZWRfZG9tYWluczoKICAgICAgICAgICAgaWYgZG9tYWluIGluIHVybDoKICAgICAgICAgICAgICAgIGluZm8uYmxvY2soVHJ1ZSkKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBCbG9ja2VkIGFkIHJlcXVlc3Q6IHt1cmx9IikKICAgICAgICAgICAgICAgIGJyZWFrCgojIE1ldGhvZCB0byBoaWRlIGFkIGVsZW1lbnRzCmRlZiBoaWRlX2FkX2VsZW1lbnRzKHNlbGYpOgogICAganNfZnVuY3Rpb24gPSAiIiIKICAgICAgICBmdW5jdGlvbiBoaWRlQWRFbGVtZW50cyhzZWxlY3RvcnMpIHsKICAgICAgICAgICAgc2VsZWN0b3JzLmZvckVhY2goZnVuY3Rpb24oc2VsZWN0b3IpIHsKICAgICAgICAgICAgICAgIHZhciBlbGVtZW50cyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpOwogICAgICAgICAgICAgICAgZWxlbWVudHMuZm9yRWFjaChmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBoaWRlQWRFbGVtZW50cyglcyk7CiAgICAiIiIgJSBqc29uLmR1bXBzKGFkX3NlbGVjdG9ycykKICAgIHNlbGYudGFicy5jdXJyZW50V2lkZ2V0KCkucGFnZSgpLnJ1bkphdmFTY3JpcHQoanNfZnVuY3Rpb24sIGxhbWJkYSBfOiBOb25lKQogICAgcHJpbnQoIltERUJVR10gQWQgZWxlbWVudHMgaGlkZGVuIikKCmNsYXNzIExvYWRpbmdQcm9ncmVzc0JhcihRUHJvZ3Jlc3NCYXIpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgc3VwZXIoTG9hZGluZ1Byb2dyZXNzQmFyLCBzZWxmKS5fX2luaXRfXygqYXJncywgKiprd2FyZ3MpCiAgICAgICAgc2VsZi5zZXRTdHlsZVNoZWV0KCIiIgogICAgICAgICAgICBRUHJvZ3Jlc3NCYXIgewogICAgICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgZ3JleTsKICAgICAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgICAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBRUHJvZ3Jlc3NCYXI6OmNodW5rIHsKICAgICAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6ICMxRTkwRkY7CiAgICAgICAgICAgICAgICB3aWR0aDogMTBweDsKICAgICAgICAgICAgfQogICAgICAgICIiIikKICAgICAgICBzZWxmLnNldE1heGltdW0oMTAwKQogICAgICAgIHNlbGYuc2V0VmFsdWUoMCkKICAgICAgICBzZWxmLnNldEZvcm1hdCgiIikKICAgICAgICBzZWxmLnNldEFsaWdubWVudChRdC5BbGlnblRvcCkKCiAgICBkZWYgc2V0X2Rvd25sb2FkX3NwZWVkKHNlbGYsIHNwZWVkKToKICAgICAgICBzZWxmLnNldEZvcm1hdCgiIikKCiMgTWFpbiB3aW5kb3cKY2xhc3MgTWFpbldpbmRvdyhRTWFpbldpbmRvdyk6CgoKICAgICMgQ29uc3RydWN0b3IKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgIHN1cGVyKE1haW5XaW5kb3csIHNlbGYpLl9faW5pdF9fKCphcmdzLCAqKmt3YXJncykKICAgICAgICBzZWxmLmFkYmxvY2tlciA9IEFkYmxvY2tlcigpCiAgICAgICAgc2VsZi5wYWdlID0gUVdlYkVuZ2luZVBhZ2UoKQogICAgICAgIHNlbGYucGFnZS5wcm9maWxlKCkuc2V0UmVxdWVzdEludGVyY2VwdG9yKHNlbGYuYWRibG9ja2VyKQogICAgICAgIHByaW50KCJbREVCVUddIEluaXRpYWxpemluZyBtYWluIHdpbmRvdyIpCgogICAgICAgICMgU2V0IHdpbmRvdyBwcm9wZXJ0aWVzCiAgICAgICAgc2VsZi5zZXRXaW5kb3dUaXRsZSgiRGlsbHVzaW9uIEJyb3dzZXIiKQogICAgICAgIHNlbGYuc2V0R2VvbWV0cnkoMTAwLCAxMDAsIDEyMDAsIDgwMCkKCiAgICAgICAgIyBDcmVhdGUgYSBjZW50cmFsIHdpZGdldAogICAgICAgIHNlbGYuY2VudHJhbF93aWRnZXQgPSBRV2lkZ2V0KCkKICAgICAgICBzZWxmLnNldENlbnRyYWxXaWRnZXQoc2VsZi5jZW50cmFsX3dpZGdldCkKCiAgICAgICAgIyBDcmVhdGUgYSB2ZXJ0aWNhbCBsYXlvdXQKICAgICAgICBzZWxmLmxheW91dCA9IFFWQm94TGF5b3V0KHNlbGYuY2VudHJhbF93aWRnZXQpCiAgICAgICAgc2VsZi5sYXlvdXQuc2V0Q29udGVudHNNYXJnaW5zKDAsIDAsIDAsIDApCgogICAgICAgICMgQ3JlYXRpbmcgYSBsb2FkaW5nIHByb2dyZXNzIGJhcgogICAgICAgIHNlbGYubG9hZGluZ19wcm9ncmVzc19iYXIgPSBMb2FkaW5nUHJvZ3Jlc3NCYXIoc2VsZikKICAgICAgICBzZWxmLmxheW91dC5hZGRXaWRnZXQoc2VsZi5sb2FkaW5nX3Byb2dyZXNzX2JhcikKCiAgICAgICAgIyBDcmVhdGluZyBhIHRhYiB3aWRnZXQKICAgICAgICBzZWxmLnRhYnMgPSBRVGFiV2lkZ2V0KCkKICAgICAgICBzZWxmLnRhYnMuc2V0RG9jdW1lbnRNb2RlKFRydWUpCiAgICAgICAgc2VsZi50YWJzLnRhYkJhckRvdWJsZUNsaWNrZWQuY29ubmVjdChzZWxmLnRhYl9vcGVuX2RvdWJsZWNsaWNrKQogICAgICAgIHNlbGYudGFicy5jdXJyZW50Q2hhbmdlZC5jb25uZWN0KHNlbGYuY3VycmVudF90YWJfY2hhbmdlZCkKICAgICAgICBzZWxmLnRhYnMuc2V0VGFic0Nsb3NhYmxlKFRydWUpCiAgICAgICAgc2VsZi50YWJzLnRhYkNsb3NlUmVxdWVzdGVkLmNvbm5lY3Qoc2VsZi5jbG9zZV9jdXJyZW50X3RhYikKICAgICAgICBzZWxmLmxheW91dC5hZGRXaWRnZXQoc2VsZi50YWJzKQoKICAgICAgICAjIENyZWF0aW5nIGEgc3RhdHVzIGJhcgogICAgICAgIHNlbGYuc3RhdHVzID0gUVN0YXR1c0JhcigpCiAgICAgICAgc2VsZi5zZXRTdGF0dXNCYXIoc2VsZi5zdGF0dXMpCgogICAgICAgICMgQ3JlYXRpbmcgYSB0b29sIGJhciBmb3IgbmF2aWdhdGlvbgogICAgICAgIG5hdnRiID0gUVRvb2xCYXIoIk5hdmlnYXRpb24iKQogICAgICAgIG5hdnRiLnNldEljb25TaXplKFFTaXplKDI0LCAyNCkpICAjIFNldCBpY29uIHNpemUgZm9yIGEgbW9kZXJuIGxvb2sKICAgICAgICBzZWxmLmFkZFRvb2xCYXIoUXQuVG9wVG9vbEJhckFyZWEsIG5hdnRiKQoKICAgICAgICAjIENyZWF0aW5nIG5hdmlnYXRpb24gYnV0dG9ucyB3aXRoIGVtb2ppcwogICAgICAgIGJhY2tfYnRuID0gUUFjdGlvbigi4qyF77iPIiwgc2VsZikKICAgICAgICBiYWNrX2J0bi5zZXRTdGF0dXNUaXAoIkJhY2sgdG8gcHJldmlvdXMgcGFnZSIpCiAgICAgICAgYmFja19idG4udHJpZ2dlcmVkLmNvbm5lY3QobGFtYmRhOiBzZWxmLnRhYnMuY3VycmVudFdpZGdldCgpLmJhY2soKSkKICAgICAgICBuYXZ0Yi5hZGRBY3Rpb24oYmFja19idG4pCgogICAgICAgIG5leHRfYnRuID0gUUFjdGlvbigi4p6h77iPIiwgc2VsZikKICAgICAgICBuZXh0X2J0bi5zZXRTdGF0dXNUaXAoIkZvcndhcmQgdG8gbmV4dCBwYWdlIikKICAgICAgICBuZXh0X2J0bi50cmlnZ2VyZWQuY29ubmVjdChsYW1iZGE6IHNlbGYudGFicy5jdXJyZW50V2lkZ2V0KCkuZm9yd2FyZCgpKQogICAgICAgIG5hdnRiLmFkZEFjdGlvbihuZXh0X2J0bikKCiAgICAgICAgcmVsb2FkX2J0biA9IFFBY3Rpb24oIvCflIQiLCBzZWxmKQogICAgICAgIHJlbG9hZF9idG4uc2V0U3RhdHVzVGlwKCJSZWxvYWQgcGFnZSIpCiAgICAgICAgcmVsb2FkX2J0bi50cmlnZ2VyZWQuY29ubmVjdChsYW1iZGE6IHNlbGYudGFicy5jdXJyZW50V2lkZ2V0KCkucmVsb2FkKCkpCiAgICAgICAgbmF2dGIuYWRkQWN0aW9uKHJlbG9hZF9idG4pCgogICAgICAgIGhvbWVfYnRuID0gUUFjdGlvbigi8J+PoCIsIHNlbGYpCiAgICAgICAgaG9tZV9idG4uc2V0U3RhdHVzVGlwKCJHbyBob21lIikKICAgICAgICBob21lX2J0bi50cmlnZ2VyZWQuY29ubmVjdChzZWxmLm5hdmlnYXRlX2hvbWUpCiAgICAgICAgbmF2dGIuYWRkQWN0aW9uKGhvbWVfYnRuKQoKICAgICAgICBuYXZ0Yi5hZGRTZXBhcmF0b3IoKQoKICAgICAgICBzZWxmLnVybGJhciA9IFFMaW5lRWRpdCgpCiAgICAgICAgc2VsZi51cmxiYXIuc2V0TWF4aW11bUhlaWdodCgzMCkgICMgU2V0IGhlaWdodCBmb3IgdGhlIFVSTCBiYXIKICAgICAgICBzZWxmLnVybGJhci5yZXR1cm5QcmVzc2VkLmNvbm5lY3Qoc2VsZi5uYXZpZ2F0ZV90b191cmwpCiAgICAgICAgbmF2dGIuYWRkV2lkZ2V0KHNlbGYudXJsYmFyKQoKICAgICAgICBzdG9wX2J0biA9IFFBY3Rpb24oIvCfm5EiLCBzZWxmKQogICAgICAgIHN0b3BfYnRuLnNldFN0YXR1c1RpcCgiU3RvcCBsb2FkaW5nIGN1cnJlbnQgcGFnZSIpCiAgICAgICAgc3RvcF9idG4udHJpZ2dlcmVkLmNvbm5lY3QobGFtYmRhOiBzZWxmLnRhYnMuY3VycmVudFdpZGdldCgpLnN0b3AoKSkKICAgICAgICBuYXZ0Yi5hZGRBY3Rpb24oc3RvcF9idG4pCgogICAgICAgIHNlbGYucHJpdmFjeV9idG4gPSBRQWN0aW9uKCLwn5W177iPIiwgc2VsZikKICAgICAgICBzZWxmLnByaXZhY3lfYnRuLnNldENoZWNrYWJsZShUcnVlKQogICAgICAgIHNlbGYucHJpdmFjeV9idG4uc2V0U3RhdHVzVGlwKCJUb2dnbGUgUHJpdmFjeSBNb2RlIikKICAgICAgICBzZWxmLnByaXZhY3lfYnRuLnRyaWdnZXJlZC5jb25uZWN0KHNlbGYudG9nZ2xlX3ByaXZhY3lfbW9kZSkKICAgICAgICBuYXZ0Yi5hZGRBY3Rpb24oc2VsZi5wcml2YWN5X2J0bikKCiAgICAgICAgc2VsZi50b3JfYnRuID0gUUFjdGlvbigi8J+nhSIsIHNlbGYpCiAgICAgICAgc2VsZi50b3JfYnRuLnNldENoZWNrYWJsZShUcnVlKQogICAgICAgIHNlbGYudG9yX2J0bi5zZXRTdGF0dXNUaXAoIlRvZ2dsZSBUb3IgTW9kZSIpCiAgICAgICAgc2VsZi50b3JfYnRuLnRyaWdnZXJlZC5jb25uZWN0KHNlbGYudG9nZ2xlX3Rvcl9tb2RlKQogICAgICAgIG5hdnRiLmFkZEFjdGlvbihzZWxmLnRvcl9idG4pCgogICAgICAgIGNsZWFyX2Nvb2tpZXNfYnRuID0gUUFjdGlvbigi8J+nuSIsIHNlbGYpCiAgICAgICAgY2xlYXJfY29va2llc19idG4uc2V0U3RhdHVzVGlwKCJDbGVhciBhbGwgY29va2llcyIpCiAgICAgICAgY2xlYXJfY29va2llc19idG4udHJpZ2dlcmVkLmNvbm5lY3Qoc2VsZi5jbGVhcl9jb29raWVzKQogICAgICAgIG5hdnRiLmFkZEFjdGlvbihjbGVhcl9jb29raWVzX2J0bikKCiAgICAgICAgbmV3X3RhYl9idG4gPSBRQWN0aW9uKCLwn4aVIiwgc2VsZikKICAgICAgICBuZXdfdGFiX2J0bi5zZXRTdGF0dXNUaXAoJ09wZW4gYSBuZXcgdGFiJykKICAgICAgICBuZXdfdGFiX2J0bi50cmlnZ2VyZWQuY29ubmVjdChsYW1iZGE6IHNlbGYuYWRkX25ld190YWIoUVVybCgnaHR0cDovL3d3dy5nb29nbGUuY29tJyksICdOZXcgVGFiJykpCiAgICAgICAgbmF2dGIuYWRkQWN0aW9uKG5ld190YWJfYnRuKQoKICAgICAgICBzZWxmLmFkZF9uZXdfdGFiKFFVcmwoJ2h0dHA6Ly93d3cuZ29vZ2xlLmNvbScpLCAnSG9tZXBhZ2UnKQoKICAgICAgICBzZWxmLmlzX3ByaXZhY3lfbW9kZSA9IEZhbHNlCiAgICAgICAgc2VsZi5pc190b3JfbW9kZSA9IEZhbHNlCiAgICAgICAgc2VsZi50b3JfcHJvZmlsZSA9IE5vbmUKCiAgICAgICAgIyBBcHBseSBjdXN0b20gc3R5bGVzaGVldAogICAgICAgIHNlbGYuYXBwbHlfc3R5bGVzKCkKCiAgICAgICAgIyBTaG93IHRoZSB3aW5kb3cKICAgICAgICBzZWxmLnNob3coKQoKICAgICMgTWV0aG9kIGZvciBhZGRpbmcgbmV3IHRhYgogICAgZGVmIGFkZF9uZXdfdGFiKHNlbGYsIHF1cmw9Tm9uZSwgbGFiZWw9IkJsYW5rIiwgcHJvZmlsZT1Ob25lKToKICAgICAgICBpZiBxdXJsIGlzIE5vbmU6CiAgICAgICAgICAgIHF1cmwgPSBRVXJsKCdodHRwOi8vd3d3Lmdvb2dsZS5jb20nKQoKICAgICAgICBpZiBwcm9maWxlIGlzIE5vbmU6CiAgICAgICAgICAgIHByb2ZpbGUgPSBRV2ViRW5naW5lUHJvZmlsZS5kZWZhdWx0UHJvZmlsZSgpCgogICAgICAgIGJyb3dzZXIgPSBRV2ViRW5naW5lVmlldygpCiAgICAgICAgcGFnZSA9IFFXZWJFbmdpbmVQYWdlKHByb2ZpbGUsIGJyb3dzZXIpCiAgICAgICAgYnJvd3Nlci5zZXRQYWdlKHBhZ2UpCiAgICAgICAgYnJvd3Nlci5zZXRVcmwocXVybCkKCiAgICAgICAgaSA9IHNlbGYudGFicy5hZGRUYWIoYnJvd3NlciwgbGFiZWwpCiAgICAgICAgc2VsZi50YWJzLnNldEN1cnJlbnRJbmRleChpKQoKICAgICAgICBicm93c2VyLnVybENoYW5nZWQuY29ubmVjdChsYW1iZGEgcXVybCwgYnJvd3Nlcj1icm93c2VyOiBzZWxmLnVwZGF0ZV91cmxiYXIocXVybCwgYnJvd3NlcikpCiAgICAgICAgYnJvd3Nlci5sb2FkRmluaXNoZWQuY29ubmVjdChsYW1iZGEgXywgaT1pLCBicm93c2VyPWJyb3dzZXI6IHNlbGYudGFicy5zZXRUYWJUZXh0KGksIGJyb3dzZXIucGFnZSgpLnRpdGxlKCkpKQogICAgICAgIGJyb3dzZXIubG9hZEZpbmlzaGVkLmNvbm5lY3QobGFtYmRhOiBoaWRlX2FkX2VsZW1lbnRzKHNlbGYpKQogICAgICAgIGJyb3dzZXIubG9hZFByb2dyZXNzLmNvbm5lY3Qoc2VsZi51cGRhdGVfbG9hZGluZ19wcm9ncmVzcykKICAgICAgICBicm93c2VyLmxvYWRGaW5pc2hlZC5jb25uZWN0KGxhbWJkYTogc2VsZi5sb2FkaW5nX3Byb2dyZXNzX2Jhci5zZXRWYWx1ZSgwKSkKCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5ldyB0YWIgYWRkZWQgd2l0aCBVUkw6IHtxdXJsLnRvU3RyaW5nKCl9IikKCiAgICAjIFdoZW4gZG91YmxlIGNsaWNrZWQgaXMgcHJlc3NlZCBvbiB0YWJzCiAgICBkZWYgdGFiX29wZW5fZG91YmxlY2xpY2soc2VsZiwgaSk6CiAgICAgICAgaWYgaSA9PSAtMToKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gRG91YmxlLWNsaWNrIGRldGVjdGVkIG9uIHRhYiBiYXIsIG9wZW5pbmcgbmV3IHRhYiIpCiAgICAgICAgICAgIHNlbGYuYWRkX25ld190YWIoUVVybCgnaHR0cDovL3d3dy5nb29nbGUuY29tJyksICdOZXcgVGFiJykKCiAgICAjIFdoZW4gdGFiIGlzIGNoYW5nZWQKICAgIGRlZiBjdXJyZW50X3RhYl9jaGFuZ2VkKHNlbGYsIGkpOgogICAgICAgIGlmIHNlbGYudGFicy5jb3VudCgpID09IDA6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGN1cnJlbnRfd2lkZ2V0ID0gc2VsZi50YWJzLmN1cnJlbnRXaWRnZXQoKQogICAgICAgIGlmIGN1cnJlbnRfd2lkZ2V0IGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHF1cmwgPSBjdXJyZW50X3dpZGdldC51cmwoKQogICAgICAgIHNlbGYudXBkYXRlX3VybGJhcihxdXJsLCBjdXJyZW50X3dpZGdldCkKICAgICAgICBzZWxmLnVwZGF0ZV90aXRsZShjdXJyZW50X3dpZGdldCkKCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFRhYiBjaGFuZ2VkIHRvIGluZGV4OiB7aX0sIFVSTDoge3F1cmwudG9TdHJpbmcoKX0iKQoKICAgICMgV2hlbiB0YWIgaXMgY2xvc2VkCiAgICBkZWYgY2xvc2VfY3VycmVudF90YWIoc2VsZiwgaSk6CiAgICAgICAgaWYgc2VsZi50YWJzLmNvdW50KCkgPCAyOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBicm93c2VyID0gc2VsZi50YWJzLndpZGdldChpKQogICAgICAgIGJyb3dzZXIuZGVsZXRlTGF0ZXIoKQogICAgICAgIHNlbGYudGFicy5yZW1vdmVUYWIoaSkKCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFRhYiBjbG9zZWQgYXQgaW5kZXg6IHtpfSIpCgogICAgIyBNZXRob2QgZm9yIHVwZGF0aW5nIHRoZSB0aXRsZQogICAgZGVmIHVwZGF0ZV90aXRsZShzZWxmLCBicm93c2VyKToKICAgICAgICBpZiBicm93c2VyICE9IHNlbGYudGFicy5jdXJyZW50V2lkZ2V0KCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHRpdGxlID0gc2VsZi50YWJzLmN1cnJlbnRXaWRnZXQoKS5wYWdlKCkudGl0bGUoKQogICAgICAgIHNlbGYuc2V0V2luZG93VGl0bGUoIiVzIC0gRGlsbHVzaW9uIEJyb3dzZXIiICUgdGl0bGUpCgogICAgICAgIHByaW50KGYiW0RFQlVHXSBXaW5kb3cgdGl0bGUgdXBkYXRlZDoge3RpdGxlfSIpCgogICAgIyBBY3Rpb24gdG8gZ28gdG8gaG9tZQogICAgZGVmIG5hdmlnYXRlX2hvbWUoc2VsZik6CiAgICAgICAgc2VsZi50YWJzLmN1cnJlbnRXaWRnZXQoKS5zZXRVcmwoUVVybCgiaHR0cDovL3d3dy5nb29nbGUuY29tIikpCiAgICAgICAgcHJpbnQoIltERUJVR10gTmF2aWdhdGluZyB0byBob21lIikKCiAgICAjIE1ldGhvZCBmb3IgbmF2aWdhdGUgdG8gVVJMCiAgICBkZWYgbmF2aWdhdGVfdG9fdXJsKHNlbGYpOgogICAgICAgIHEgPSBRVXJsKHNlbGYudXJsYmFyLnRleHQoKSkKICAgICAgICBpZiBxLnNjaGVtZSgpID09ICIiOgogICAgICAgICAgICBxLnNldFNjaGVtZSgiaHR0cCIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5hdmlnYXRpbmcgdG8gVVJMOiB7cS50b1N0cmluZygpfSIpCiAgICAgICAgc2VsZi5wZXJmb3JtX2Ruc19zcG9vZl9jaGVjayhxKQoKICAgICMgTWV0aG9kIHRvIHVwZGF0ZSB0aGUgVVJMIGJhcgogICAgZGVmIHVwZGF0ZV91cmxiYXIoc2VsZiwgcSwgYnJvd3Nlcj1Ob25lKToKICAgICAgICBpZiBicm93c2VyICE9IHNlbGYudGFicy5jdXJyZW50V2lkZ2V0KCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHNlbGYudXJsYmFyLnNldFRleHQocS50b1N0cmluZygpKQogICAgICAgIHNlbGYudXJsYmFyLnNldEN1cnNvclBvc2l0aW9uKDApCgogICAgICAgIHByaW50KGYiW0RFQlVHXSBVUkwgYmFyIHVwZGF0ZWQ6IHtxLnRvU3RyaW5nKCl9IikKCiAgICAjIE1ldGhvZCB0byB0b2dnbGUgcHJpdmFjeSBtb2RlCiAgICBkZWYgdG9nZ2xlX3ByaXZhY3lfbW9kZShzZWxmKToKICAgICAgICB1cmxzID0gW3NlbGYudGFicy53aWRnZXQoaSkudXJsKCkgZm9yIGkgaW4gcmFuZ2Uoc2VsZi50YWJzLmNvdW50KCkpXQogICAgICAgIGlmIHNlbGYuaXNfcHJpdmFjeV9tb2RlOgogICAgICAgICAgICBzZWxmLmlzX3ByaXZhY3lfbW9kZSA9IEZhbHNlCiAgICAgICAgICAgIHNlbGYucHJpdmFjeV9idG4uc2V0Q2hlY2tlZChGYWxzZSkKICAgICAgICAgICAgc2VsZi5yZWxvYWRfdGFic193aXRoX3Byb2ZpbGUoUVdlYkVuZ2luZVByb2ZpbGUuZGVmYXVsdFByb2ZpbGUoKSwgdXJscykKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gUHJpdmFjeSBtb2RlIGRpc2FibGVkIikKICAgICAgICBlbHNlOgogICAgICAgICAgICBwcml2YWN5X3Byb2ZpbGUgPSBRV2ViRW5naW5lUHJvZmlsZShzZWxmKQogICAgICAgICAgICBwcml2YWN5X3Byb2ZpbGUuc2V0SHR0cENhY2hlVHlwZShRV2ViRW5naW5lUHJvZmlsZS5NZW1vcnlIdHRwQ2FjaGUpCiAgICAgICAgICAgIHByaXZhY3lfcHJvZmlsZS5zZXRQZXJzaXN0ZW50Q29va2llc1BvbGljeShRV2ViRW5naW5lUHJvZmlsZS5Ob1BlcnNpc3RlbnRDb29raWVzKQogICAgICAgICAgICBzZWxmLmlzX3ByaXZhY3lfbW9kZSA9IFRydWUKICAgICAgICAgICAgc2VsZi5wcml2YWN5X2J0bi5zZXRDaGVja2VkKFRydWUpCiAgICAgICAgICAgIHNlbGYucmVsb2FkX3RhYnNfd2l0aF9wcm9maWxlKHByaXZhY3lfcHJvZmlsZSwgdXJscykKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gUHJpdmFjeSBtb2RlIGVuYWJsZWQiKQoKICAgICMgTWV0aG9kIHRvIHRvZ2dsZSBUb3IgbW9kZQogICAgZGVmIHRvZ2dsZV90b3JfbW9kZShzZWxmKToKICAgICAgICB1cmxzID0gW3NlbGYudGFicy53aWRnZXQoaSkudXJsKCkgZm9yIGkgaW4gcmFuZ2Uoc2VsZi50YWJzLmNvdW50KCkpXQogICAgICAgIGlmIHNlbGYuaXNfdG9yX21vZGU6CiAgICAgICAgICAgIHNlbGYuaXNfdG9yX21vZGUgPSBGYWxzZQogICAgICAgICAgICBzZWxmLnRvcl9idG4uc2V0Q2hlY2tlZChGYWxzZSkKICAgICAgICAgICAgUU5ldHdvcmtQcm94eS5zZXRBcHBsaWNhdGlvblByb3h5KFFOZXR3b3JrUHJveHkoKSkgICMgUmVzZXQgdG8gbm8gcHJveHkKICAgICAgICAgICAgc2VsZi5yZWxvYWRfdGFic193aXRoX3Byb2ZpbGUoUVdlYkVuZ2luZVByb2ZpbGUuZGVmYXVsdFByb2ZpbGUoKSwgdXJscykKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gVG9yIG1vZGUgZGlzYWJsZWQiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYudG9yX3Byb2ZpbGUgPSBRV2ViRW5naW5lUHJvZmlsZShzZWxmKQogICAgICAgICAgICBwcm94eSA9IFFOZXR3b3JrUHJveHkoKQogICAgICAgICAgICBwcm94eS5zZXRUeXBlKFFOZXR3b3JrUHJveHkuU29ja3M1UHJveHkpCiAgICAgICAgICAgIHByb3h5LnNldEhvc3ROYW1lKCIxMjcuMC4wLjEiKQogICAgICAgICAgICBwcm94eS5zZXRQb3J0KDkwNTApCiAgICAgICAgICAgIFFOZXR3b3JrUHJveHkuc2V0QXBwbGljYXRpb25Qcm94eShwcm94eSkKICAgICAgICAgICAgc2VsZi5pc190b3JfbW9kZSA9IFRydWUKICAgICAgICAgICAgc2VsZi50b3JfYnRuLnNldENoZWNrZWQoVHJ1ZSkKICAgICAgICAgICAgc2VsZi5yZWxvYWRfdGFic193aXRoX3Byb2ZpbGUoc2VsZi50b3JfcHJvZmlsZSwgdXJscykKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gVG9yIG1vZGUgZW5hYmxlZCIpCgogICAgIyBNZXRob2QgdG8gY2xlYXIgY29va2llcwogICAgZGVmIGNsZWFyX2Nvb2tpZXMoc2VsZik6CiAgICAgICAgcHJvZmlsZSA9IHNlbGYudGFicy5jdXJyZW50V2lkZ2V0KCkucGFnZSgpLnByb2ZpbGUoKQogICAgICAgIHByb2ZpbGUuY2xlYXJIdHRwQ2FjaGUoKQogICAgICAgIHByb2ZpbGUuY29va2llU3RvcmUoKS5kZWxldGVBbGxDb29raWVzKCkKICAgICAgICBwcmludCgiW0RFQlVHXSBDb29raWVzIGNsZWFyZWQiKQoKICAgICMgTWV0aG9kIHRvIHJlbG9hZCBhbGwgdGFicyB3aXRoIGEgZ2l2ZW4gcHJvZmlsZQogICAgZGVmIHJlbG9hZF90YWJzX3dpdGhfcHJvZmlsZShzZWxmLCBwcm9maWxlLCB1cmxzKToKICAgICAgICBzZWxmLnRhYnMuY2xlYXIoKQogICAgICAgIGZvciB1cmwgaW4gdXJsczoKICAgICAgICAgICAgc2VsZi5hZGRfbmV3X3RhYih1cmwsIHByb2ZpbGU9cHJvZmlsZSkKICAgICAgICBwcmludCgiW0RFQlVHXSBUYWJzIHJlbG9hZGVkIHdpdGggbmV3IHByb2ZpbGUiKQoKICAgICMgTWV0aG9kIGZvciBETlMgc3Bvb2YgY2hlY2sKICAgIGRlZiBwZXJmb3JtX2Ruc19zcG9vZl9jaGVjayhzZWxmLCBxdXJsKToKICAgICAgICBkb21haW4gPSBxdXJsLmhvc3QoKQogICAgICAgIHRyeToKICAgICAgICAgICAgcHVibGljX2lwID0gc29ja2V0LmdldGhvc3RieW5hbWUoZG9tYWluKQogICAgICAgICAgICBsb2NhbF9pcCA9IHNvY2tldC5nZXRob3N0YnluYW1lKGRvbWFpbikgICMgVXNlIGEgbG9jYWwgRE5TIHJlc29sdmVyCiAgICAgICAgICAgIGlmIHB1YmxpY19pcCA9PSBsb2NhbF9pcDoKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBQdWJsaWMgYW5kIGxvY2FsIEROUyBtYXRjaCBmb3Ige2RvbWFpbn0sIGZldGNoaW5nIGRpcmVjdGx5IikKICAgICAgICAgICAgICAgIHNlbGYudGFicy5jdXJyZW50V2lkZ2V0KCkuc2V0VXJsKHF1cmwpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludChmIltXQVJOXSBETlMgbWlzbWF0Y2ggZm9yIHtkb21haW59LiBQdWJsaWMgSVA6IHtwdWJsaWNfaXB9LCBMb2NhbCBJUDoge2xvY2FsX2lwfSIpCiAgICAgICAgICAgICAgICBzZWxmLnRhYnMuY3VycmVudFdpZGdldCgpLnNldFVybChRVXJsKGYiaHR0cDovL3twdWJsaWNfaXB9IikpCiAgICAgICAgZXhjZXB0IHNvY2tldC5nYWllcnJvciBhcyBlOgogICAgICAgICAgICBwcmludChmIltGQVRBTF0gRE5TIHJlc29sdXRpb24gZmFpbGVkIGZvciB7ZG9tYWlufToge2V9IikKICAgICAgICAgICAgaWYgImNocm9tZTovLyIgaW4gcXVybC50b1N0cmluZygpOgogICAgICAgICAgICAgICAgc2VsZi50YWJzLmN1cnJlbnRXaWRnZXQoKS5zZXRVcmwocXVybCkKICAgICAgICAgICAgUU1lc3NhZ2VCb3guY3JpdGljYWwoc2VsZiwgJ0ROUyBFcnJvcicsIGYiRmFpbGVkIHRvIHJlc29sdmUgRE5TIGZvciB7ZG9tYWlufToge2V9IikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi50YWJzLmN1cnJlbnRXaWRnZXQoKS5zZXRVcmwocXVybCkKICAgICAgICAgICAgZXhjZXB0IHNvY2tldC5oZXJyb3IgYXMgZToKICAgICAgICAgICAgICAgIFFNZXNzYWdlQm94LmNyaXRpY2FsKHNlbGYsICdGYXRhbCcsIGYie2RvbWFpbn0gY3Jhc2hlZCB0aGUgYnJvd3NlciB7ZX0iKQoKICAgICMgTWV0aG9kIHRvIHVwZGF0ZSB0aGUgbG9hZGluZyBwcm9ncmVzcwogICAgZGVmIHVwZGF0ZV9sb2FkaW5nX3Byb2dyZXNzKHNlbGYsIHZhbHVlKToKICAgICAgICBzZWxmLmxvYWRpbmdfcHJvZ3Jlc3NfYmFyLnNldFZhbHVlKHZhbHVlKQogICAgICAgIGlmIHZhbHVlID09IDEwMDoKICAgICAgICAgICAgZG93bmxvYWRfc3BlZWQgPSBzZWxmLmdldF9kb3dubG9hZF9zcGVlZCgpCiAgICAgICAgICAgIHNlbGYubG9hZGluZ19wcm9ncmVzc19iYXIuc2V0X2Rvd25sb2FkX3NwZWVkKCIiKQoKICAgICMgTWV0aG9kIHRvIGdldCB0aGUgZG93bmxvYWQgc3BlZWQKICAgIGRlZiBnZXRfZG93bmxvYWRfc3BlZWQoc2VsZik6CiAgICAgICAgcGFnZSA9IHNlbGYudGFicy5jdXJyZW50V2lkZ2V0KCkucGFnZSgpCiAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgdG90YWxfYnl0ZXMgPSAwCgogICAgICAgIGRlZiBjYWxsYmFjayhieXRlc19yZWNlaXZlZCk6CiAgICAgICAgICAgIG5vbmxvY2FsIHRvdGFsX2J5dGVzCiAgICAgICAgICAgIHRvdGFsX2J5dGVzICs9IGJ5dGVzX3JlY2VpdmVkCgogICAgICAgIHBhZ2UubG9hZFByb2dyZXNzLmNvbm5lY3QoY2FsbGJhY2spCiAgICAgICAgdGltZS5zbGVlcCgxKQogICAgICAgIGVsYXBzZWRfdGltZSA9IHRpbWUudGltZSgpIC0gc3RhcnRfdGltZQogICAgICAgIGRvd25sb2FkX3NwZWVkID0gKHRvdGFsX2J5dGVzIC8gZWxhcHNlZF90aW1lKSAvICgxMDI0ICogMTAyNCkKICAgICAgICByZXR1cm4gIiIKCiAgICAjIEFwcGx5IGN1c3RvbSBzdHlsZXNoZWV0CiAgICBkZWYgYXBwbHlfc3R5bGVzKHNlbGYpOgogICAgICAgIHNlbGYuc2V0U3R5bGVTaGVldCgiIiIKICAgICAgICAgICAgUU1haW5XaW5kb3cgewogICAgICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogI0Y1RjVGNTsKICAgICAgICAgICAgfQogICAgICAgICAgICBRVG9vbEJhciB7CiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiAjRkZGRkZGOwogICAgICAgICAgICAgICAgcGFkZGluZzogNXB4OwogICAgICAgICAgICAgICAgYm9yZGVyOiBub25lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIFFUYWJXaWRnZXQ6OnBhbmUgewogICAgICAgICAgICAgICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkICNDMkM3Q0I7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgICAgICB0b3A6IC0wLjVlbTsKICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6ICNGRkZGRkY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgUVRhYldpZGdldDo6dGFiLWJhciB7CiAgICAgICAgICAgICAgICBhbGlnbm1lbnQ6IGNlbnRlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBRVGFiQmFyOjp0YWIgewogICAgICAgICAgICAgICAgYmFja2dyb3VuZDogI0UwRTBFMDsKICAgICAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNDNEM0QzM7CiAgICAgICAgICAgICAgICBwYWRkaW5nOiAxMHB4OwogICAgICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIFFUYWJCYXI6OnRhYjpzZWxlY3RlZCwgUVRhYkJhcjo6dGFiOmhvdmVyIHsKICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6ICNGRkZGRkY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgUUxpbmVFZGl0IHsKICAgICAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNDNEM0QzM7CiAgICAgICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICAgICAgICAgICAgICBwYWRkaW5nOiA1cHg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgUVN0YXR1c0JhciB7CiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiAjRkZGRkZGOwogICAgICAgICAgICAgICAgcGFkZGluZzogM3B4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIFFUb29sQnV0dG9uIHsKICAgICAgICAgICAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIFFUb29sQnV0dG9uOmhvdmVyIHsKICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6ICNFMEUwRTA7CiAgICAgICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICAgICAgICAgIH0KICAgICAgICAiIiIpCiAgICAgICAgcHJpbnQoIltERUJVR10gU3R5bGVzIGFwcGxpZWQiKQoKCiMgQ3JlYXRpbmcgYSBQeVF0NSBhcHBsaWNhdGlvbgphcHAgPSBRQXBwbGljYXRpb24oc3lzLmFyZ3YpCmFwcC5zZXRBcHBsaWNhdGlvbk5hbWUoIkRpbGx1c2lvbiBCcm93c2VyIikKCiMgQ3JlYXRpbmcgTWFpbldpbmRvdyBvYmplY3QKd2luZG93ID0gTWFpbldpbmRvdygpCmFwcC5leGVjXygp'

# Base64-encoded contents of ad_selectors.json
AD_SELECTORS_JSON = b'WyIuYWQtYmFubmVyIiwgIi5hZC1jb250YWluZXIiLCAiLmFkIl0='

# Base64-encoded contents of blocked_domains.json
BLOCKED_DOMAINS_JSON = b'WyJkb3VibGVjbGljay5uZXQiLCAiZ29vZ2xlYWRzZXJ2aWNlcy5jb20iLCAiYWR2ZXJ0aXNpbmcuY29tIl0='
class LocationPage(QWizardPage):
    def __init__(self, parent=None):
        super(LocationPage, self).__init__(parent)
        self.setTitle("Installation Location")
        self.setSubTitle("Choose where to install Dillusion Browser.")
        self.location_edit = QLineEdit()
        self.location_edit.setPlaceholderText("Enter installation path or leave blank for default")
        layout = QVBoxLayout()
        layout.addWidget(self.location_edit)
        self.setLayout(layout)

    def validatePage(self):
        location = self.location_edit.text()
        if location and not os.path.isdir(location):
            return False
        return True

class OptionsPage(QWizardPage):
    def __init__(self, parent=None):
        super(OptionsPage, self).__init__(parent)
        self.setTitle("Installation Options")
        self.setSubTitle("Choose additional options for the installation.")
        desktop_shortcut = QCheckBox("Create desktop shortcut")
        start_menu_shortcut = QCheckBox("Create start menu shortcut")
        layout = QVBoxLayout()
        options_group = QGroupBox("Options")
        options_layout = QVBoxLayout()
        options_layout.addWidget(desktop_shortcut)
        options_layout.addWidget(start_menu_shortcut)
        options_group.setLayout(options_layout)
        layout.addWidget(options_group)
        self.setLayout(layout)
# ... (rest of the code remains the same) ...
class IntroPage(QWizardPage):
    def __init__(self, parent=None):
        super(IntroPage, self).__init__(parent)
        self.setTitle("Welcome to the Dillusion Browser Installer")
        label = QLabel("This wizard will guide you through the installation process.")
        layout = QVBoxLayout()
        layout.addWidget(label)
        self.setLayout(layout)
class ConclusionPage(QWizardPage):
    def __init__(self, parent=None):
        super(ConclusionPage, self).__init__(parent)
        self.setTitle("Installation Complete")
        label = QLabel("Dillusion Browser has been installed successfully. ")
        layout = QVBoxLayout()
        layout.addWidget(label)
        self.setLayout(layout)

class InstallerWizard(QWizard):
    def __init__(self, parent=None):
        super(InstallerWizard, self).__init__(parent)
        self.addPage(IntroPage())
        self.addPage(LocationPage())
        self.addPage(OptionsPage())
        self.addPage(ConclusionPage())
        self.setWindowTitle("Dillusion Browser Installer")
        self.setWizardStyle(QWizard.ModernStyle)

    def accept(self):
        location = self.page(1).layout().itemAt(0).widget().text()
        if not location:
            location = os.path.join(os.path.expanduser("~"), "Dillusion Browser")
        options_page = self.page(2)

        # Create the installation directory if it doesn't exist
        os.makedirs(location, exist_ok=True)

        # Write the base64-encoded files to the installation directory
        with open(os.path.join(location, "main.py"), "wb") as f:
            f.write(base64.b64decode(MAIN_PY))
        with open(os.path.join(location, "ad_selectors.json"), "wb") as f:
            f.write(base64.b64decode(AD_SELECTORS_JSON))
        with open(os.path.join(location, "blocked_domains.json"), "wb") as f:
            f.write(base64.b64decode(BLOCKED_DOMAINS_JSON))
        # Create start menu shortcut
        run_sh_path = os.path.join(location, "run.sh")
        print('[WARN] Sudo needed')
        with open(run_sh_path, "w") as f:
            f.write(f"#!/bin/sh\npython3 {os.path.join(location, 'main.py')}")
        os.chmod(run_sh_path, 0o755)  # Make the script executable
        # Here, you could perform additional installation tasks based on the selected options
        print(f"Installing Dillusion Browser to: {location}")

        super().accept()

if __name__ == "__main__":
    app = QApplication(sys.argv)
    wizard = InstallerWizard()
    wizard.show()
    sys.exit(app.exec_())
